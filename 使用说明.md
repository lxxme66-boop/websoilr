# DeepSeek 翻译工具使用说明

## 主要改进

1. **修复了长文档只翻译一部分的问题**
   - 优化了文本分割算法，确保所有内容都被翻译
   - 增加了翻译覆盖率检查，显示翻译完成度

2. **智能文本分割**
   - 优先按段落分割，保持文档结构
   - 对超长段落进行句子级分割
   - 验证分割后内容完整性

3. **更好的用户体验**
   - 可选择分片大小（小/中/大）
   - 实时显示翻译进度和统计信息
   - 翻译完成后显示覆盖率

## 运行方法

### 1. 基本运行
```bash
python translate_deepseek_improved.py
```

### 2. 后台运行（推荐用于大量文件）
```bash
nohup python translate_deepseek_improved.py > translate.log 2>&1 &
```

### 3. 使用 screen 运行（可以断开连接后继续）
```bash
# 创建新的 screen 会话
screen -S translate

# 运行翻译程序
python translate_deepseek_improved.py

# 按 Ctrl+A 然后按 D 来分离会话
# 重新连接：screen -r translate
```

## 使用步骤

1. **选择模型**
   ```
   1. DeepSeek-R1-Distill-Qwen-1.5B (最快)
   2. DeepSeek-R1-Distill-Qwen-7B (推荐)
   3. DeepSeek-R1-Distill-Qwen-14B (高质量)
   4. gte_Qwen2-7B-instruct (备选)
   ```

2. **输入文件夹路径**
   - 输入包含英文txt文件的文件夹路径
   - 例如：`/home/user/english_docs`

3. **输出文件夹路径**
   - 默认为 `./chinese_translations`
   - 可以自定义路径

4. **选择分片大小**
   - 小片段 (800字符) - 更精确但速度慢
   - 中片段 (1500字符) - 平衡选择（推荐）
   - 大片段 (3000字符) - 速度快但可能遗漏

## 输出说明

每个翻译文件包含：
- 文件头部信息（原文件大小、分片数量、翻译时间等）
- 完整的中文翻译内容
- 文件名格式：`原文件名_中文.txt`

## 翻译质量检查

程序会自动计算翻译覆盖率：
- **覆盖率 > 80%**：翻译完整
- **覆盖率 50-80%**：基本完整，可能有少量遗漏
- **覆盖率 < 50%**：会显示警告，建议检查

## 常见问题

### Q: 翻译不完整怎么办？
A: 尝试使用更小的分片大小重新翻译

### Q: 程序中断了怎么办？
A: 程序会跳过已翻译的文件，可以直接重新运行

### Q: 如何提高翻译速度？
A: 使用较小的模型（如1.5B）或增大分片大小

### Q: 内存不足怎么办？
A: 使用较小的模型，或在运行前清理内存：
```bash
# 清理缓存
sync && echo 3 > /proc/sys/vm/drop_caches
```

## 性能参考

- **1.5B模型**：约 500-1000 字符/秒
- **7B模型**：约 200-500 字符/秒
- **14B模型**：约 100-300 字符/秒

## 批量处理建议

对于大量文件（>100个），建议：
1. 使用 screen 或 tmux 运行
2. 选择 7B 模型（平衡质量和速度）
3. 使用中等分片大小
4. 定期检查日志文件

## 监控进度

```bash
# 查看实时输出
tail -f translate.log

# 统计已完成文件
ls chinese_translations/*_中文.txt | wc -l
```

## 高级配置

### 自定义提示词模板

如果需要特定领域的翻译（如学术、技术文档），可以修改代码中的prompt：

```python
# 在 translate_files 函数中修改 prompt
prompt = f"""请将以下英文内容完整翻译成中文。注意：
1. 保持原文的格式和结构
2. 专业术语要准确
3. 不要遗漏任何内容
4. [可以添加特定领域要求，如：保留学术引用格式]

英文原文：
{chunk}

中文翻译："""
```

### 处理特殊文件格式

对于包含特殊格式的文档（如表格、代码块等）：

1. **表格文档**：建议使用小片段(800字符)确保表格结构完整
2. **代码文档**：保持代码块的完整性，避免在代码中间分割
3. **混合文档**：使用中等片段，程序会智能识别段落边界

### 优化建议

1. **GPU内存管理**
   ```bash
   # 查看GPU使用情况
   nvidia-smi
   
   # 释放GPU内存
   sudo fuser -v /dev/nvidia*
   ```

2. **批处理优化**
   - 将文件按大小分组，先处理小文件
   - 使用多个终端并行处理不同文件夹
   - 定期保存进度，避免重复翻译

3. **质量控制**
   - 对重要文档使用14B模型
   - 使用小片段确保完整性
   - 人工抽查翻译质量

## 故障排除

### 1. 模型加载失败
```bash
# 检查模型路径
ls -la /mnt/storage/models/deepseek-ai/

# 检查权限
chmod -R 755 /mnt/storage/models/

# 检查磁盘空间
df -h
```

### 2. 翻译中断恢复
```bash
# 查找未完成的文件
comm -23 <(ls input_folder/*.txt | sort) <(ls chinese_translations/*_中文.txt | sed 's/_中文//' | sort)

# 继续翻译未完成的文件
python translate_deepseek_improved.py
```

### 3. 内存溢出处理
```bash
# 限制进程内存使用
ulimit -v 16000000  # 限制为16GB

# 使用更小的批次
# 修改代码中的 max_new_tokens 参数
```

## 翻译质量提升技巧

### 1. 预处理文档
```bash
# 清理特殊字符
sed -i 's/[^\x00-\x7F]//g' input.txt

# 统一换行符
dos2unix input.txt

# 去除多余空行
sed -i '/^$/N;/^\n$/d' input.txt
```

### 2. 后处理翻译结果
```bash
# 修复常见翻译问题
# 如：修复标点符号
sed -i 's/。。/。/g' output_中文.txt
sed -i 's/，，/，/g' output_中文.txt

# 统一专业术语
# 创建术语替换脚本
```

### 3. 批量验证
```python
# 创建验证脚本 check_translation.py
import os
from pathlib import Path

def check_translations(input_dir, output_dir):
    input_files = list(Path(input_dir).glob("*.txt"))
    
    for input_file in input_files:
        output_file = Path(output_dir) / f"{input_file.stem}_中文.txt"
        
        if output_file.exists():
            with open(input_file, 'r') as f:
                input_size = len(f.read())
            with open(output_file, 'r') as f:
                output_size = len(f.read())
            
            coverage = (output_size / input_size) * 100
            if coverage < 80:
                print(f"⚠️  {input_file.name}: {coverage:.1f}% 覆盖率")
        else:
            print(f"❌ {input_file.name}: 未找到翻译文件")
```

## 实用脚本集

### 1. 批量重命名脚本
```bash
#!/bin/bash
# rename_translations.sh
# 批量重命名翻译文件

for file in chinese_translations/*_中文.txt; do
    newname=$(echo $file | sed 's/_中文/_CN/')
    mv "$file" "$newname"
done
```

### 2. 翻译进度监控脚本
```bash
#!/bin/bash
# monitor_progress.sh
# 实时监控翻译进度

while true; do
    clear
    echo "翻译进度监控"
    echo "============="
    echo "总文件数: $(ls input_folder/*.txt | wc -l)"
    echo "已完成: $(ls chinese_translations/*_中文.txt 2>/dev/null | wc -l)"
    echo ""
    echo "最近翻译的文件:"
    ls -lt chinese_translations/*_中文.txt 2>/dev/null | head -5
    sleep 10
done
```

### 3. 自动重试脚本
```bash
#!/bin/bash
# auto_retry.sh
# 自动重试失败的翻译

max_retries=3
retry_count=0

while [ $retry_count -lt $max_retries ]; do
    python translate_deepseek_improved.py
    
    # 检查是否还有未翻译的文件
    remaining=$(comm -23 <(ls input_folder/*.txt | sort) <(ls chinese_translations/*_中文.txt | sed 's/_中文//' | sort) | wc -l)
    
    if [ $remaining -eq 0 ]; then
        echo "✅ 所有文件翻译完成!"
        break
    else
        echo "⚠️  还有 $remaining 个文件未翻译，重试中..."
        retry_count=$((retry_count + 1))
        sleep 60
    fi
done
```

## 最佳实践总结

1. **文档准备**
   - 确保文档编码为UTF-8
   - 预先检查文档大小和复杂度
   - 按类型分组处理

2. **模型选择**
   - 日常文档：7B模型
   - 技术文档：14B模型
   - 快速预览：1.5B模型

3. **分片策略**
   - 普通文本：中等片段(1500)
   - 复杂格式：小片段(800)
   - 简单内容：大片段(3000)

4. **质量保证**
   - 设置合理的覆盖率阈值
   - 定期抽查翻译质量
   - 保留原文以供对照

5. **效率优化**
   - 使用后台运行处理大批量
   - 合理安排翻译顺序
   - 及时清理临时文件

## 联系与反馈

如遇到问题或有改进建议，请：
1. 检查日志文件中的错误信息
2. 确认环境配置是否正确
3. 尝试使用不同的模型或参数

记住：好的翻译需要时间，耐心等待会得到更好的结果！

## 工具集说明

### 1. 主翻译脚本
- `translate_deepseek_improved.py` - 改进版翻译脚本，支持长文档完整翻译
- `quick_translate.sh` - 快速启动脚本，提供多种运行模式

### 2. 质量检查工具
- `check_translation.py` - 检查翻译完整性和覆盖率

使用示例：
```bash
# 基本检查
python check_translation.py input_folder output_folder

# 设置最低覆盖率要求
python check_translation.py input_folder output_folder --min-coverage 90
```

### 3. 进度监控工具
- `monitor_progress.sh` - 实时监控翻译进度和系统资源

使用示例：
```bash
# 默认5秒刷新
./monitor_progress.sh input_folder output_folder

# 自定义刷新间隔
./monitor_progress.sh input_folder output_folder 10
```

### 4. 批量翻译辅助工具
- `batch_translate_helper.py` - 提供文件预处理、批量管理等功能

主要功能：
- **预处理文件**：检查编码、统计文件信息、生成处理建议
- **分批处理**：将大量文件分成小批次，避免内存溢出
- **合并结果**：将批次结果合并到一个目录
- **生成报告**：创建详细的翻译报告

使用示例：
```bash
# 预处理文件（检查编码、统计信息）
python batch_translate_helper.py preprocess -i input_folder

# 将文件分批（默认每批50个）
python batch_translate_helper.py split -i input_folder

# 自定义批次大小
python batch_translate_helper.py split -i input_folder -b 30

# 合并批次结果
python batch_translate_helper.py merge -o output_folder

# 生成翻译报告
python batch_translate_helper.py report -i input_folder -o output_folder
```

## 完整工作流程示例

### 场景1：处理少量文件（<50个）
```bash
# 1. 直接运行翻译
python translate_deepseek_improved.py

# 2. 监控进度（新终端）
./monitor_progress.sh input_folder chinese_translations

# 3. 检查结果
python check_translation.py input_folder chinese_translations
```

### 场景2：处理大量文件（>100个）
```bash
# 1. 预处理文件
python batch_translate_helper.py preprocess -i input_folder

# 2. 分批处理
python batch_translate_helper.py split -i input_folder -b 50

# 3. 运行批处理脚本
./run_batches.sh

# 4. 合并结果
python batch_translate_helper.py merge

# 5. 生成报告
python batch_translate_helper.py report -i input_folder -o chinese_translations
```

### 场景3：后台批量处理
```bash
# 1. 使用screen创建会话
screen -S batch_translate

# 2. 预处理和分批
python batch_translate_helper.py preprocess -i input_folder
python batch_translate_helper.py split -i input_folder

# 3. 运行批处理
./run_batches.sh

# 4. 分离screen（Ctrl+A, D）
# 5. 稍后重新连接查看进度
screen -r batch_translate
```

### 场景4：处理特殊格式文档
```bash
# 1. 预处理检查
python batch_translate_helper.py preprocess -i input_folder

# 2. 对大文件使用小片段
# 运行翻译时选择：
# - 模型：7B或14B
# - 分片大小：1（小片段800字符）

# 3. 严格检查覆盖率
python check_translation.py input_folder output_folder --min-coverage 90
```

## 故障恢复流程

### 1. 翻译中断后继续
```bash
# 检查哪些文件未完成
python check_translation.py input_folder output_folder

# 继续翻译（程序会跳过已完成的文件）
python translate_deepseek_improved.py
```

### 2. 批量重试失败文件
```bash
# 生成需要重试的文件列表
python check_translation.py input_folder output_folder

# retry_files.txt 会自动生成
# 手动处理这些文件
```

### 3. 内存溢出处理
```bash
# 减小批次大小
python batch_translate_helper.py split -i input_folder -b 20

# 使用更小的模型
# 运行时选择 1.5B 模型
```

## 性能优化建议

### 1. 根据文件大小选择策略
- **小文件(<10KB)**：使用大片段(3000)，批量处理
- **中等文件(10-100KB)**：使用中片段(1500)，标准处理
- **大文件(>100KB)**：使用小片段(800)，单独处理

### 2. 根据文件数量选择模式
- **<20个文件**：交互式运行，实时查看
- **20-100个文件**：后台运行，定期检查
- **>100个文件**：分批处理，使用screen

### 3. 资源管理
- **GPU内存不足**：减小批次，使用小模型
- **CPU负载高**：减少并发，增加间隔
- **磁盘空间**：定期清理，压缩备份

## 常用命令速查

```bash
# 快速开始
./quick_translate.sh

# 检查进度
ls chinese_translations/*_中文.txt | wc -l

# 查看日志
tail -f translate_*.log

# 检查质量
python check_translation.py input output

# 监控资源
nvidia-smi -l 5
htop

# 清理缓存
sync && echo 3 > /proc/sys/vm/drop_caches

# 压缩结果
tar -czf translations_$(date +%Y%m%d).tar.gz chinese_translations/
```

## 注意事项

1. **备份原文件**：翻译前建议备份重要文件
2. **检查编码**：确保文件为UTF-8编码
3. **预留空间**：确保有足够的磁盘空间（至少原文件2倍）
4. **定期保存**：长时间运行建议定期备份结果
5. **质量抽查**：完成后随机抽查几个文件的翻译质量

祝您翻译顺利！如有问题，请参考错误日志或联系技术支持。